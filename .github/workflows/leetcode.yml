name: LeetCode Stats Tracker
on:
  schedule:
    - cron: '0 18 * * *'  # Daily at 6 PM UTC
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Create outputs directory
        run: mkdir -p outputs

      - name: Fetch LeetCode data
        run: |
          # GraphQL query for ALL stats
          QUERY='{
            "query":"query getUserProfile($username: String!) {
              matchedUser(username: $username) {
                submitStats {
                  acSubmissionNum { difficulty count }
                  totalSubmissionNum { count }
                }
                profile {
                  ranking
                  reputation
                  starRating
                }
                userContestRanking {
                  rating
                  topPercentage
                  attendedContestsCount
                  globalRanking
                }
                recentSubmissionList(limit: 5) { title timestamp }
                languageProblemCount {
                  languageName
                  problemsSolved
                }
              }
            }",
            "variables":{"username":"ananymishradev"}
          }'

          # Try with 3 retries
          for i in {1..3}; do
            curl -X POST \
              -H "Content-Type: application/json" \
              -H "Referer: https://leetcode.com/ananymishradev/" \
              -d "$QUERY" \
              https://leetcode.com/graphql > outputs/leetcode_raw.json && break
            sleep 5
          done

          # Process ALL stats with error handling
          jq '{
            # Problem stats
            solved: (.data.matchedUser.submitStats.acSubmissionNum[0].count // 0),
            easy: (.data.matchedUser.submitStats.acSubmissionNum[1].count // 0),
            medium: (.data.matchedUser.submitStats.acSubmissionNum[2].count // 0),
            hard: (.data.matchedUser.submitStats.acSubmissionNum[3].count // 0),
            totalSubmissions: (.data.matchedUser.submitStats.totalSubmissionNum[0].count // 0),
            
            # Profile stats
            ranking: (.data.matchedUser.profile.ranking // "N/A"),
            reputation: (.data.matchedUser.profile.reputation // 0),
            stars: (.data.matchedUser.profile.starRating // 0),
            
            # Contest stats
            contestRating: (.data.matchedUser.userContestRanking.rating // 0 | floor),
            contestTopPercent: (.data.matchedUser.userContestRanking.topPercentage // 0),
            contestsAttended: (.data.matchedUser.userContestRanking.attendedContestsCount // 0),
            globalRank: (.data.matchedUser.userContestRanking.globalRanking // "N/A"),
            
            # Activity stats
            lastSubmission: (.data.matchedUser.recentSubmissionList[0].title // "N/A"),
            lastSubmissionTime: (.data.matchedUser.recentSubmissionList[0].timestamp // 0),
            
            # Language stats
            topLanguage: (
              .data.matchedUser.languageProblemCount 
              | max_by(.problemsSolved).languageName 
              // "N/A"
            ),
            acceptanceRate: (
              (.data.matchedUser.submitStats.acSubmissionNum[0].count / 
               .data.matchedUser.submitStats.totalSubmissionNum[0].count * 100 
               | round(1)) 
              // 0
            )
          }' outputs/leetcode_raw.json > outputs/stats.json || echo '{}' > outputs/stats.json

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Generate enhanced SVG
        run: |
          pip install python-dateutil
          python scripts/generate_svg.py
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git add outputs/*
          git diff-index --quiet HEAD || git commit -m "Update LeetCode stats [skip ci]"
          git push
